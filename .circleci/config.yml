image71: &image-71
  docker:
  - image: circleci/php:7.1-apache-stretch-node-browsers

image72: &image-72
  docker:
  - image: circleci/php:7.2-apache-stretch-node-browsers

restore-cache: &restore-72-cache
  restore_cache:
      keys:
      - v1-72-dependencies-{{ checksum "composer.lock" }}
      - v1-72-dependencies-

composer-install: &composer-install
  run:
    name: Composer install
    command: composer install  --no-interaction --no-scripts --prefer-dist

save-cache: &save-72-cache
  save_cache:
    key: v1-72-dependencies-{{ checksum "composer.lock" }}
    paths:
    - vendor



version: 2

jobs:

  build-71:
    <<: *image-71

    steps:
      - checkout
      - restore_cache:
          keys:
          - v1-71-dependencies-{{ checksum "composer.lock" }}
          - v1-71-dependencies-
      - *composer-install
      - save_cache:
          key: v1-dependencies-{{ checksum "composer.lock" }}
          paths:
          - vendor
      - run:
          name: Run full CI process
          command: composer ci

  build-72:
    <<: *image-72

    steps:
      - checkout
      - *restore-72-cache
      - *composer-install
      - *save-72-cache
      - run:
          name: Run full CI process
          command: composer ci
      - store-test-results:
          path: reports
      - store-artifacts:
          path: reports


  security:
    <<: *image-72

    steps:
      - checkout
      - *restore-72-cache
      - *composer-install
      - *save-72-cache
      - run:
          name: Run security check
          command: composer security

workflows:
  version: 2
  commit:
    jobs:
      - build-71
      - build-72

  security-check:
    triggers:
      - schedule:
          cron: "33 12 * * *"
          filters:
            branches:
              only: master

    jobs:
      - security
